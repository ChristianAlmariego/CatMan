<?xml version="1.0" encoding="UTF-8"?>

<!--
      =================================================================
  Licensed Materials - Property of IBM

  WebSphere Commerce

  (C) Copyright IBM Corp. 2013, 2014 All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or
  disclosure restricted by GSA ADP Schedule Contract with
  IBM Corp.
 =================================================================
    select catentry_id from
            (select catgpenrel.catentry_id, catgpenrel.catgroup_id, storeent.identifier as STORENAME, catgroup.identifier AS SALES_PATH from catgpenrel 
              left join catgroup on catgroup.catgroup_id = catgpenrel.catgroup_id
              left join storecat on storecat.catalog_id = catgpenrel.catalog_id
              left join storeent on storeent.storeent_id = storecat.storeent_id
            where catgpenrel.catalog_id in (select catalog_id from catalog where identifier IN ('CLIMATE_SALES_CATALOG','INSINKERATOR_SALES_CATALOG','SENSI_SALES_CATALOG','PROTEAM_SALES_CATALOG','FAN_SALES_CATALOG','WSV_SALES_CATALOG'))
              and catgroup.markfordelete = 0 order by catgpenrel.catentry_id, catgroup.identifier) group by catentry_id, storename
-->

<_config:DataloadBusinessObjectConfiguration
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.ibm.com/xmlns/prod/commerce/foundation/config ../../../WC/xml/config/xsd/wc-dataload-businessobject.xsd"
        xmlns:_config="http://www.ibm.com/xmlns/prod/commerce/foundation/config">

  <_config:DataLoader className="com.ibm.commerce.foundation.dataload.BusinessObjectLoader">
    <_config:DataReader className="com.ibm.commerce.foundation.dataload.datareader.UniqueIdReader">
            <_config:Query>
              <_config:SQL>
                    <![CDATA[
				 SELECT  
				 CATENTRY.CATENTRY_ID, CATGPENREL.CATGROUP_ID
				FROM
								CATGPENREL
				JOIN 
								CATGROUP ON (CATGROUP.CATGROUP_ID = CATGPENREL.CATGROUP_ID)
				JOIN 
								CATENTRY ON (CATENTRY.CATENTRY_ID = CATGPENREL.CATENTRY_ID)
				JOIN
								STOREENT ON (STOREENT.MEMBER_ID = CATGROUP.MEMBER_ID)
				WHERE 
              CATENTRY.MARKFORDELETE = 0 AND 
						  CATGPENREL.CATENTRY_ID IN (
               select catentry_id from
            (select catgpenrel.catentry_id, catgpenrel.catgroup_id, storeent.identifier as STORENAME, catgroup.identifier AS SALES_PATH from catgpenrel 
              left join catgroup on catgroup.catgroup_id = catgpenrel.catgroup_id
              left join storecat on storecat.catalog_id = catgpenrel.catalog_id
              left join storeent on storeent.storeent_id = storecat.storeent_id
            where catgpenrel.catalog_id in (select catalog_id from catalog where identifier IN ('CLIMATE_SALES_CATALOG','INSINKERATOR_SALES_CATALOG','SENSI_SALES_CATALOG','PROTEAM_SALES_CATALOG','FAN_SALES_CATALOG','WSV_SALES_CATALOG'))
              and catgroup.markfordelete = 0 order by catgpenrel.catentry_id, catgroup.identifier) group by catentry_id, storename
              )     
               

                    ]]>
              </_config:SQL>
   
            </_config:Query>

    </_config:DataReader>
        <_config:BusinessObjectBuilder className="com.ibm.commerce.foundation.dataload.businessobjectbuilder.PassThroughBusinessObjectBuilder">
                <_config:BusinessObjectMediator className="com.ibm.commerce.foundation.dataload.businessobjectmediator.AssociatedObjectMediator">

                        <_config:Query>
                                <_config:SQL>
                                        <![CDATA[
			  
              		 SELECT
							CATENTRY.PARTNUMBER, CATGROUP.IDENTIFIER GROUPIDENTIFIER, STOREENT.IDENTIFIER STOREIDENTIFIER, CATGPENREL.SEQUENCE, CATENTRY.MARKFORDELETE
				FROM
								CATGPENREL
				JOIN 
								CATGROUP ON (CATGROUP.CATGROUP_ID = CATGPENREL.CATGROUP_ID)
				JOIN 
								CATENTRY ON (CATENTRY.CATENTRY_ID = CATGPENREL.CATENTRY_ID)
				JOIN
								STOREENT ON (STOREENT.MEMBER_ID = CATGROUP.MEMBER_ID)
                  
				WHERE 
                                STOREENT.STOREENT_ID IN (10152, 10154, 10153, 10155, 10156, 10157)  AND  CATENTRY.MARKFORDELETE = 0
                                AND CATGPENREL.CATENTRY_ID = ? AND CATGPENREL.CATGROUP_ID = ?
                                ORDER BY CATENTRY.PARTNUMBER, CATGROUP.IDENTIFIER
                                
                                        ]]>
                                        </_config:SQL>
                             <_config:Param name="CATENTRY_ID" />
                               <_config:Param name="CATGROUP_ID" />      
                               
                                <_config:ColumnMapping name="PARTNUMBER" value="Code" />
                                <_config:ColumnMapping name="GROUPIDENTIFIER" value="Sales Category Identifier" />
                                <_config:ColumnMapping name="STOREIDENTIFIER" value="Store" />
                                <_config:ColumnMapping name="SEQUENCE" value="Sequence" /> 
             </_config:Query>

                        <_config:DataWriter className="com.ibm.commerce.foundation.dataload.datawriter.CSVWriter">
                                <_config:Data>
                                        <_config:column name="Code" number="1"/>
                                        <_config:column name="Sales Category Identifier" number="2"/>      
                                          <_config:column name="Store" number="3"/>
                                        <_config:column name="Sequence" number="4"/>
                                </_config:Data>
                        </_config:DataWriter>

          </_config:BusinessObjectMediator>
    </_config:BusinessObjectBuilder>
  </_config:DataLoader>

</_config:DataloadBusinessObjectConfiguration>