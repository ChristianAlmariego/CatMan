<?xml version="1.0" encoding="UTF-8"?>

<!--
      =================================================================
  Licensed Materials - Property of IBM

  WebSphere Commerce

  (C) Copyright IBM Corp. 2013, 2014 All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or
  disclosure restricted by GSA ADP Schedule Contract with
  IBM Corp.
 =================================================================
-->
<_config:DataloadBusinessObjectConfiguration
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.ibm.com/xmlns/prod/commerce/foundation/config ../../../WC/xml/config/xsd/wc-dataload-businessobject.xsd"
        xmlns:_config="http://www.ibm.com/xmlns/prod/commerce/foundation/config">

  <_config:DataLoader className="com.ibm.commerce.foundation.dataload.BusinessObjectLoader">
    <_config:DataReader className="com.ibm.commerce.foundation.dataload.datareader.UniqueIdReader">
            <_config:Query>
              <_config:SQL>
                    <![CDATA[
						select catentry.catentry_id from catentry
						    inner join
						        (select catgpenrel.catentry_id, catgpenrel.catgroup_id, catgroup.identifier AS MASTER_PATH from catgpenrel 
						            left join catgroup on catgroup.catgroup_id = catgpenrel.catgroup_id
						            where catgroup.catgroup_id IN
						            (
						              select catgroup_id_child from
						                (
						                    select catgroup_id_child, catgroup_id_parent, LEVEL AS parentlevel from catgrprel start with
						                        catgroup_id_parent IN (select catgroup_id from catgroup where catgroup_id IN (?,?)) connect by prior
						                        catgroup_id_child = catgroup_id_parent
						                )   cattree
						                left join catgroup on cattree.catgroup_id_parent = catgroup.catgroup_id
						                where catgroup.markfordelete = 0
						              UNION
						              select catgroup_id as catgroup_id_child from catgroup
						                where catgroup_id IN (select catgroup_id from catgroup where catgroup_id IN (?,?))
						            ) 
						            order by catgpenrel.catentry_id, catgroup.identifier
						        ) catentrymaster on catentry.catentry_id = catentrymaster.catentry_id
						where catentry.markfordelete = 0
                    ]]>
              </_config:SQL>
              <_config:Param name="catGroupIdComRes" value="14503" />         
              <_config:Param name="catGroupIdETC" value="10001" />         
              <_config:Param name="catGroupIdComRes2" value="14503" />         
              <_config:Param name="catGroupIdETC2" value="10001" />         
            </_config:Query>

    </_config:DataReader>
        <_config:BusinessObjectBuilder className="com.ibm.commerce.foundation.dataload.businessobjectbuilder.PassThroughBusinessObjectBuilder">
                <_config:BusinessObjectMediator className="com.ibm.commerce.foundation.dataload.businessobjectmediator.AssociatedObjectMediator">

                        <_config:Query>
                                <_config:SQL>
                                        <![CDATA[
  										select catentry.catentry_id, catentry.partnumber, catentry.mfname, catentry.mfpartnumber, catentdesc.name,
										        seopagedefdesc.title, seopagedefdesc.meta_desc as meta_desc,
										        seourlkeyword.urlkeyword,
										        case when catentdesc.published = 1 then 'TRUE' else 'FALSE' end as published,
										        case when catentry.catenttype_id = 'ItemBean' then 'SKU' 
										            when catentry.catenttype_id = 'ProductBean' then 'Product' 
										            when catentry.catenttype_id = 'BundleBean' then 'Bundle'
										            when catentry.catenttype_id = 'PackageBean' then 'Static Kit'
										            when catentry.catenttype_id = 'DynamicKitBean' then 'Dynamic Kit'      
										        end as catenttype_id,
										        catentrysales.storename, 
										        catentrymaster.master_path,
										        to_char(catentry.lastupdate, 'MM-DD-YYYY') as lastupdate,
														'' as datecreated,
												case when catentry.buyable = 1 then 'TRUE' else 'FALSE' end as buyable,
                            					catentryattr.emrPDPFormat
										    from catentry
										    inner join
										        (select catgpenrel.catentry_id, catgpenrel.catgroup_id, catgroup.identifier AS MASTER_PATH from catgpenrel 
										            left join catgroup on catgroup.catgroup_id = catgpenrel.catgroup_id
										            where catgroup.catgroup_id IN
										            (
										              select catgroup_id_child from
										                (
										                    select catgroup_id_child, catgroup_id_parent, LEVEL AS parentlevel from catgrprel start with
										                        catgroup_id_parent IN (select catgroup_id from catgroup where catgroup_id IN (?,?)) connect by prior
										                        catgroup_id_child = catgroup_id_parent
										                )   cattree
										                left join catgroup on cattree.catgroup_id_parent = catgroup.catgroup_id
										                where catgroup.markfordelete = 0
										              UNION
										              select catgroup_id as catgroup_id_child from catgroup
										                where catgroup_id IN (select catgroup_id from catgroup where catgroup_id IN (?,?))
										            ) 
										            order by catgpenrel.catentry_id, catgroup.identifier
										        ) catentrymaster on catentry.catentry_id = catentrymaster.catentry_id

											left join (select  catentryattr.catentry_id,attrvaldesc.value as datecreated from catentryattr 
											left join attr  on attr.attr_id = catentryattr.attr_id
											left join attrvaldesc on attrvaldesc.attrval_id = catentryattr.attrval_id
											where attr.identifier = ? and attrvaldesc.language_id = ?) catentryattr on catentryattr.catentry_id = catentry.catentry_id

											left join (select catentryattr.catentry_id, attrvaldesc.value as emrPDPFormat from catentryattr
                      						left join attr on attr.attr_id = catentryattr.attr_id
                      						left join attrvaldesc on attrvaldesc.attrval_id = catentryattr.attrval_id
                     						where attr.identifier = ? and attrvaldesc.language_id = ?) catentryattr on catentryattr.catentry_id = catentry.catentry_id  

										    left join (select * from catentdesc where catentdesc.language_id = ?) catentdesc
										        on catentry.catentry_id = catentdesc.catentry_id
										    left join seopagedef on seopagedef.pagename = CONCAT('PRODUCT_PAGE_' , catentry.catentry_id)
										    left join (select * from seopagedefdesc where language_id = ?) seopagedefdesc 
										        on seopagedefdesc.seopagedef_id = seopagedef.seopagedef_id
										    left join seourl on seourl.tokenvalue = to_char(catentry.catentry_id)
										    left join (select * from seourlkeyword where language_id = ? and status = 1) seourlkeyword
										        on seourlkeyword.seourl_id = seourl.seourl_id
										    left join
										      (select catentry_id, storename, LISTAGG(SALES_PATH, '|') within group (order by SALES_PATH) AS SALES_PATH from
										        (select catgpenrel.catentry_id, catgpenrel.catgroup_id, 
													case when storeent.identifier = 'InSinkErator' then 'ISE' else storeent.identifier end as STORENAME, 
													catgroup.identifier AS SALES_PATH from catgpenrel 
										          left join catgroup on catgroup.catgroup_id = catgpenrel.catgroup_id
										          left join storecat on storecat.catalog_id = catgpenrel.catalog_id
										          left join storeent on storeent.storeent_id = storecat.storeent_id
										        where catgpenrel.catalog_id in (select catalog_id from catalog where catalog_id IN (?,?,?,?,?,?))
										          and catgroup.markfordelete = 0
										        order by catgpenrel.catentry_id, catgroup.identifier) group by catentry_id, storename
										      ) catentrysales on catentry.catentry_id = catentrysales.catentry_id
										where catentry.markfordelete = 0
										    and catentry.catentry_id = ?
                                      ]]>
                                    </_config:SQL>  
						            <_config:Param name="catGroupIdComRes" value="14503" />         
						            <_config:Param name="catGroupIdETC" value="10001" />         
						            <_config:Param name="catGroupIdComRes2" value="14503" />         
						            <_config:Param name="catGroupIdETC2" value="10001" />     
								 	<_config:Param name="emrDateCreated" value="EMR Date Created" />    
									  <_config:Param name="langId" valueFrom="BusinessContext" />    
									<_config:Param name="emrPDPFormat" value="EMR PDP Format" />    
									  <_config:Param name="langId" valueFrom="BusinessContext" />    
					                <_config:Param name="langId" valueFrom="BusinessContext" />
					                <_config:Param name="langId" valueFrom="BusinessContext" />
					                <_config:Param name="langId" valueFrom="BusinessContext" />
					                <_config:Param name="catalogIdClimate" value="10054" />
					                <_config:Param name="catalogIdInsinkerator" value="10055" />
					                <_config:Param name="catalogIdSensi" value="10056" />
					                <_config:Param name="catalogIdProTeam" value="10053" />
					                <_config:Param name="catalogIdFans" value="10051" />
					                <_config:Param name="catalogIdVacs" value="10052" />
					                <_config:Param name="CATENTRY_ID" />
					                
	                                <_config:ColumnMapping name="PARTNUMBER" value="Code" />
	                                <_config:ColumnMapping name="MFNAME" value="Manufacturer" />
	                                <_config:ColumnMapping name="MFPARTNUMBER" value="Manufacturer part number" />
	                                <_config:ColumnMapping name="NAME" value="Name US" />
	                                <_config:ColumnMapping name="TITLE" value="Page Title US" />
	                                <_config:ColumnMapping name="META_DESC" value="Meta Description US" />
	                                <_config:ColumnMapping name="URLKEYWORD" value="URL Keyword US" />
	                                <_config:ColumnMapping name="PUBLISHED" value="Display to customer US" />
	                                <_config:ColumnMapping name="CATENTTYPE_ID" value="Catalog Entry Type" />
	                                <_config:ColumnMapping name="STORENAME" value="Store" />
	                                <_config:ColumnMapping name="MASTER_PATH" value="Full Path" />
	                                <_config:ColumnMapping name="LASTUPDATE" value="Last Update" />
									<_config:ColumnMapping name="DATECREATED" value="Date Created" />
									<_config:ColumnMapping name="BUYABLE" value="For Purchase" />
									<_config:ColumnMapping name="EMRPDPFORMAT" value="PDP Format" />
            </_config:Query>

                        <_config:DataWriter className="com.ibm.commerce.foundation.dataload.datawriter.CSVWriter">
                                <_config:Data>
                                        <_config:column name="Code" number="1"/>
                                        <_config:column name="Manufacturer" number="2"/>
                                        <_config:column name="Manufacturer part number" number="3"/>
                                        <_config:column name="Name US" number="4"/>
                                        <_config:column name="Page Title US" number="5"/>
                                        <_config:column name="Meta Description US" number="6"/>
                                        <_config:column name="URL Keyword US" number="7"/>
                                        <_config:column name="Display to customer US" number="8"/>                                        
                                        <_config:column name="Catalog Entry Type" number="9"/>      
                                        <_config:column name="Store" number="10"/>       
                                        <_config:column name="Full Path" number="11"/> 
                                        <_config:column name="Last Update" number="12"/>     
										<_config:column name="Date Created" number="13"/>  
										<_config:column name="For Purchase" number="14"/>   
										<_config:column name="PDP Format" number="15"/>                   
                                </_config:Data>
                        </_config:DataWriter>

          </_config:BusinessObjectMediator>
    </_config:BusinessObjectBuilder>
  </_config:DataLoader>

</_config:DataloadBusinessObjectConfiguration>
