<?xml version="1.0" encoding="UTF-8"?>

<!--
      =================================================================
  Licensed Materials - Property of IBM

  WebSphere Commerce

  (C) Copyright IBM Corp. 2013, 2014 All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or
  disclosure restricted by GSA ADP Schedule Contract with
  IBM Corp.
 =================================================================
-->
<_config:DataloadBusinessObjectConfiguration
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.ibm.com/xmlns/prod/commerce/foundation/config ../../../WC/xml/config/xsd/wc-dataload-businessobject.xsd"
        xmlns:_config="http://www.ibm.com/xmlns/prod/commerce/foundation/config">

  <_config:DataLoader className="com.ibm.commerce.foundation.dataload.BusinessObjectLoader">
    <_config:DataReader className="com.ibm.commerce.foundation.dataload.datareader.UniqueIdReader">
     <_config:Query>
       <_config:SQL>
             <![CDATA[
				select catentryattr.catentry_id
				from catentryattr
				left join attr on catentryattr.attr_id = attr.attr_id
				where identifier IN ('${attributeIdentifier}')
              ]]>
       </_config:SQL>
     </_config:Query>

    </_config:DataReader>
        <_config:BusinessObjectBuilder className="com.ibm.commerce.foundation.dataload.businessobjectbuilder.PassThroughBusinessObjectBuilder">
                <_config:BusinessObjectMediator className="com.ibm.commerce.foundation.dataload.businessobjectmediator.AssociatedObjectMediator">
                 <_config:Query>
                         <_config:SQL>
                                 <![CDATA[

									select catentry.catentry_id, catentry.partnumber, 
									    catentrymaster.master_path, catentrysales.sales_path, 
									    case when catentry.catenttype_id = 'ItemBean' then 'SKU' 
									        when catentry.catenttype_id = 'ProductBean' then 'Product' 
									        when catentry.catenttype_id = 'BundleBean' then 'Bundle'
									        when catentry.catenttype_id = 'PackageBean' then 'Static Kit'
									        when catentry.catenttype_id = 'DynamicKitBean' then 'Dynamic Kit'      
									    end as cattype,
									    catentdesc.name, catentdesc.longdescription, catentdesc.shortdescription,
									    catentdesc.keyword, catentry.mfname, catentry.mfpartnumber,
									    catentryplatform.platform, catentrylocale.locale, catentrysales.storename,
									    catentrycustomattr.targetattribute
									  from catentry
									    inner join
									      (select catgpenrel.catentry_id, catgpenrel.catgroup_id, catgroup.identifier AS MASTER_PATH from catgpenrel 
									          left join catgroup on catgroup.catgroup_id = catgpenrel.catgroup_id
									        where catgroup.catgroup_id IN
									        (
									          select catgroup_id_child from
									          (
									          select catgroup_id_child, catgroup_id_parent, LEVEL AS parentlevel from catgrprel start with
									              catgroup_id_parent IN (select catgroup_id from catgroup where identifier IN ('M-EMR','ETC')) connect by prior
									            catgroup_id_child = catgroup_id_parent
									            ) cattree
									            left join catgroup on cattree.catgroup_id_parent = catgroup.catgroup_id
									            where catgroup.markfordelete = 0
									          UNION
									          select catgroup_id as catgroup_id_child from catgroup
									            where catgroup_id IN (select catgroup_id from catgroup where identifier IN ('M-EMR','ETC'))
									        ) 
									        order by catgpenrel.catentry_id, catgroup.identifier
									      ) catentrymaster on catentry.catentry_id = catentrymaster.catentry_id  
									    left join
									      (select catentry_id, storename, LISTAGG(SALES_PATH, '|') within group (order by SALES_PATH) AS SALES_PATH from
									        (select catgpenrel.catentry_id, catgpenrel.catgroup_id, storeent.identifier as STORENAME, catgroup.identifier AS SALES_PATH from catgpenrel 
									          left join catgroup on catgroup.catgroup_id = catgpenrel.catgroup_id
									          left join storecat on storecat.catalog_id = catgpenrel.catalog_id
									          left join storeent on storeent.storeent_id = storecat.storeent_id
									        where catgpenrel.catalog_id in (select catalog_id from catalog where catalog_id IN (20051,10054,10055,10056,10051,10052,10053))
									          and catgroup.markfordelete = 0
									        order by catgpenrel.catentry_id, catgroup.identifier) group by catentry_id, storename
									      ) catentrysales on catentry.catentry_id = catentrysales.catentry_id
									    left join (select * from catentdesc where catentdesc.language_id = -1) catentdesc on catentry.catentry_id = catentdesc.catentry_id
									    left join 
									    (
									        select catentryattr.catentry_id, catentryattr.attrval_id, attrvaldesc.value as platform
									        from catentryattr 
									        left join attrvaldesc on (catentryattr.attrval_id = attrvaldesc.attrval_id and attrvaldesc.language_id = -1)
									        where catentryattr.attr_id in (select attr_id from attr where identifier = 'EMR Platform')
									    ) catentryplatform on catentry.catentry_id = catentryplatform.catentry_id
									    left join
									    (
									        select catentryattr.catentry_id, catentryattr.attrval_id, attrvaldesc.value as locale
									        from catentryattr 
									        left join attrvaldesc on (catentryattr.attrval_id = attrvaldesc.attrval_id and attrvaldesc.language_id = -1)
									        where catentryattr.attr_id in (select attr_id from attr where identifier = 'EMR Locale')
									    ) catentrylocale on catentry.catentry_id = catentrylocale.catentry_id
									    left join 
									    (
									        select catentryattr.catentry_id, catentryattr.attrval_id, attrvaldesc.value as targetattribute
									        from catentryattr 
									        left join attrvaldesc on (catentryattr.attrval_id = attrvaldesc.attrval_id and attrvaldesc.language_id = -1)
									        where catentryattr.attr_id in (select attr_id from attr where identifier in ('${attributeIdentifier}'))
									    ) catentrycustomattr on catentry.catentry_id = catentrycustomattr.catentry_id
									    where catentry.markfordelete = 0
									    and catentry.catentry_id = ?
                                 ]]>
                                 </_config:SQL>
					            <_config:Param name="CATENTRY_ID" />
		
		                        <_config:ColumnMapping name="STORENAME" value="Store" />
		                        <_config:ColumnMapping name="MASTER_PATH" value="Full Path" />
		                        <_config:ColumnMapping name="SALES_PATH" value="Sales Catalog(s) Path" />
		                        <_config:ColumnMapping name="CATTYPE" value="Catalog Entry Type" />
		                        <_config:ColumnMapping name="NAME" value="US Name" />
		                        <_config:ColumnMapping name="LONGDESCRIPTION" value="Long Description" />
		                        <_config:ColumnMapping name="KEYWORD" value="Keyword US" />
		                        <_config:ColumnMapping name="MFNAME" value="Manufacturer" />
		                        <_config:ColumnMapping name="MFPARTNUMBER" value="Manufacturer part number" />
		                        <_config:ColumnMapping name="PLATFORM" value="Platform" />
		                        <_config:ColumnMapping name="LOCALE" value="Locale" />
		                        <_config:ColumnMapping name="TARGETATTRIBUTE" value="${TargetAttributeHeader}" />
	           </_config:Query>

               <_config:DataWriter className="com.ibm.commerce.foundation.dataload.datawriter.CSVWriter">
	                <_config:Data>
                       <_config:column name="Store" number="1"/>
                       <_config:column name="Full Path" number="2"/>
                       <_config:column name="Sales Catalog(s) Path" number="3"/>
                       <_config:column name="Catalog Entry Type" number="4"/>
                       <_config:column name="US Name" number="5"/>
                       <_config:column name="Long Description" number="6"/>
                       <_config:column name="Keyword US" number="7"/>
                       <_config:column name="Manufacturer" number="8"/>
                       <_config:column name="Manufacturer part number" number="9"/>
                       <_config:column name="Platform" number="10"/>
                       <_config:column name="Locale" number="11"/>
                       <_config:column name="${TargetAttributeHeader}" number="12"/>
	                </_config:Data>
               </_config:DataWriter>

          </_config:BusinessObjectMediator>
    </_config:BusinessObjectBuilder>
  </_config:DataLoader>

</_config:DataloadBusinessObjectConfiguration>
